<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CamNext — Chat aleatorio P2P (PeerJS)</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--accent:#0d6efd}
    body{background:#f6f7fb;}
    .app{max-width:1100px;margin:24px auto}
    .video-wrap{background:#111;border-radius:12px;padding:8px;}
    video{width:100%;height:auto;border-radius:8px;background:#000}
    .user-badge{font-weight:600}
    .chat-box{height:340px;overflow:auto;background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e6e6}
    .message.me{text-align:right}
    .file-item{font-size:.9rem}
    .small-muted{font-size:.85rem;color:#6c757d}
    .top-ids{font-size:.9rem}
  </style>
</head>
<body>
  <div class="container app">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">CamNext <small class="small-muted">— Conexiones P2P (PeerJS)</small></h2>
      <div>
        <span id="uidBadge" class="badge bg-secondary user-badge">Generando...</span>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-7">
        <div class="video-wrap mb-3">
          <div class="row g-2">
            <div class="col-6">
              <label class="small-muted">Tu cámara</label>
              <video id="localVideo" autoplay muted playsinline></video>
              <div class="d-flex gap-2 mt-2">
                <button id="toggleCam" class="btn btn-sm btn-outline-primary">Cam</button>
                <button id="toggleMic" class="btn btn-sm btn-outline-primary">Mic</button>
                <button id="shareScreen" class="btn btn-sm btn-outline-secondary">Compartir pantalla</button>
              </div>
            </div>
            <div class="col-6">
              <label class="small-muted">Conectado a</label>
              <video id="remoteVideo" autoplay playsinline></video>
              <div class="d-flex gap-2 mt-2">
                <button id="passBtn" class="btn btn-sm btn-danger">Siguiente</button>
                <button id="stopBtn" class="btn btn-sm btn-outline-danger">Desconectar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <div class="d-flex gap-2 align-items-center mb-2">
            <input id="nameInput" class="form-control form-control-sm" placeholder="Tu nombre (opcional)" />
            <button id="saveName" class="btn btn-sm btn-primary">Guardar</button>
            <button id="findBtn" class="btn btn-sm btn-success">Buscar aleatorio</button>
            <button id="copyLinkBtn" class="btn btn-sm btn-outline-secondary">Copiar mi link</button>
          </div>
          <div class="d-flex gap-2 align-items-center mt-2">
            <input id="otherIdInput" class="form-control form-control-sm" placeholder="Conectar con ID..." />
            <button id="connectToId" class="btn btn-sm btn-primary">Conectar</button>
          </div>
          <div class="mt-2 small-muted">Si la búsqueda automática no encuentra a nadie, copialo y pegalo en otro dispositivo o comparte tu link.</div>
        </div>
      </div>

      <div class="col-md-5">
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Chat & Archivos</strong>
            <small class="small-muted" id="roomLabel">No conectado</small>
          </div>
          <div id="chatBox" class="chat-box mb-2"></div>

          <div class="d-flex gap-2">
            <input id="chatInput" class="form-control form-control-sm" placeholder="Escribí algo..." />
            <button id="sendBtn" class="btn btn-sm btn-primary">Enviar</button>
          </div>

          <div class="d-flex gap-2 mt-2">
            <input type="file" id="fileInput" class="form-control form-control-sm" />
            <button id="sendFileBtn" class="btn btn-sm btn-outline-primary">Enviar archivo</button>
          </div>

          <div class="mt-2 small-muted">Los archivos se transfieren P2P cuando sea posible. Si falla, intentá reconectar o usar el link directo.</div>
        </div>

        <div class="card p-3">
          <strong>Mi estado / IDs</strong>
          <div class="top-ids mt-2">
            <div>Mi ID: <code id="myId">-</code></div>
            <div>Mi link: <code id="myLink">-</code></div>
            <div class="mt-1 small-muted">Abrí el link en otro dispositivo para conectar automáticamente.</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center small-muted mt-4">CamNext — Demo usando <strong>PeerJS public server</strong>. Para producción agregá TURN y seguridad.</footer>
  </div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
  // =========================
  // Config y utilidades
  // =========================
  function uid(len=8){
    const s = crypto.getRandomValues(new Uint8Array(len)).reduce((acc,v)=>acc+v.toString(16).padStart(2,'0'),'');
    return s.slice(0,16);
  }
  const localKey = 'camnext:user';
  let localUser = JSON.parse(localStorage.getItem(localKey) || 'null');
  if(!localUser){ localUser = { id: uid(), name: 'User-'+Math.floor(Math.random()*9000+1000) }; localStorage.setItem(localKey, JSON.stringify(localUser)); }

  // UI refs
  const uidBadge = document.getElementById('uidBadge');
  const nameInput = document.getElementById('nameInput');
  const saveName = document.getElementById('saveName');
  const findBtn = document.getElementById('findBtn');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const otherIdInput = document.getElementById('otherIdInput');
  const connectToId = document.getElementById('connectToId');
  const myIdEl = document.getElementById('myId');
  const myLinkEl = document.getElementById('myLink');
  const passBtn = document.getElementById('passBtn');
  const stopBtn = document.getElementById('stopBtn');
  const roomLabel = document.getElementById('roomLabel');
  const chatBox = document.getElementById('chatBox');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const toggleCam = document.getElementById('toggleCam');
  const toggleMic = document.getElementById('toggleMic');
  const shareScreen = document.getElementById('shareScreen');
  const sendFileBtn = document.getElementById('sendFileBtn');
  const fileInput = document.getElementById('fileInput');

  uidBadge.textContent = `${localUser.name} — ${localUser.id.slice(0,8)}`;
  nameInput.value = localUser.name;

  saveName.addEventListener('click', ()=>{ localUser.name = nameInput.value.trim() || localUser.name; localStorage.setItem(localKey, JSON.stringify(localUser)); uidBadge.textContent = `${localUser.name} — ${localUser.id.slice(0,8)}`; });

  // Si la URL tiene ?peer=<id> conectar automáticamente al abrir
  const urlParams = new URLSearchParams(window.location.search);
  const autoConnectId = urlParams.get('peer');

  // =========================
  // Media
  // =========================
  let localStream = null;
  async function startLocalMedia(){
    try{ localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true}); localVideo.srcObject = localStream; }catch(e){ console.warn('Media error',e); appendSystem('No se pudo acceder a cámara/mic.'); }
  }
  startLocalMedia();

  toggleCam.addEventListener('click', ()=>{ if(!localStream) return; const t = localStream.getVideoTracks()[0]; if(t) t.enabled = !t.enabled; toggleCam.textContent = t && t.enabled ? 'Cam ON' : 'Cam OFF'; });
  toggleMic.addEventListener('click', ()=>{ if(!localStream) return; const t = localStream.getAudioTracks()[0]; if(t) t.enabled = !t.enabled; toggleMic.textContent = t && t.enabled ? 'Mic ON' : 'Mic OFF'; });

  shareScreen.addEventListener('click', async ()=>{ try{ const s = await navigator.mediaDevices.getDisplayMedia({video:true}); const track = s.getVideoTracks()[0]; if(window.currentCall && window.currentCall.peerConnection){ const sender = window.currentCall.peerConnection.getSenders().find(s=>s.track && s.track.kind==='video'); if(sender) sender.replaceTrack(track); } localVideo.srcObject = s; track.onended = ()=>{ if(localStream) localVideo.srcObject = localStream; }; }catch(e){console.warn('Screen share cancelled',e);} });

  // =========================
  // PeerJS setup (usa servidor público de PeerJS)
  // =========================
  // Nota: PeerJS public server (0.peerjs.com) se utiliza aquí para señalización.
  // Para mejorar la confiabilidad en producción añadí TURN servers en iceServers.
  const peer = new Peer(localUser.id, {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
        // Agregá TURN si tenés credenciales:
        // { urls: 'turn:mi-turn-server:3478', username: 'user', credential: 'pass' }
      ]
    }
  });

  let conn = null; // DataConnection
  let currentCall = null;
  let incomingFile = null;

  peer.on('open', id=>{
    myIdEl.textContent = id;
    const link = `${location.origin}${location.pathname}?peer=${encodeURIComponent(id)}`;
    myLinkEl.textContent = link;
    uidBadge.textContent = `${localUser.name} — ${id.slice(0,8)}`;
    appendSystem('Conectado a PeerJS: ' + id);
    // si vinimos con ?peer= otro, conectar automático
    if(autoConnectId && autoConnectId !== id){ otherIdInput.value = autoConnectId; setTimeout(()=>connectById(autoConnectId), 800); }
  });
  peer.on('error', err=>{ console.warn('Peer error',err); appendSystem('Error Peer: '+err); });

  // recibir conexiones de datos
  peer.on('connection', c=>{
    if(conn){ // ya conectado: rechazar
      c.on('open', ()=>{ c.send({type:'busy'}); c.close(); });
      return;
    }
    conn = c; setupDataConn();
  });

  // recibir llamadas media
  peer.on('call', call=>{
    if(currentCall){ try{ call.close(); }catch(e){} return; }
    currentCall = call;
    if(localStream) call.answer(localStream);
    call.on('stream', s=>{ remoteVideo.srcObject = s; });
    call.on('close', ()=>{ remoteVideo.srcObject = null; currentCall = null; appendSystem('Llamada finalizada'); });
  });

  function setupDataConn(){
    conn.on('open', ()=>{ appendSystem('Canal de datos abierto'); });
    conn.on('data', msg=>{
      try{
        if(msg.type === 'chat') appendChat(msg.text, msg.name || 'Anon');
        else if(msg.type==='file-meta'){ incomingFile = {meta: msg.meta, chunks: [], received:0}; appendSystem('Recibiendo archivo: '+msg.meta.name); }
        else if(msg.type==='file-chunk'){ if(incomingFile) incomingFile.chunks.push(new Uint8Array(msg.chunk)); }
        else if(msg.type==='file-end'){ const blob = new Blob(incomingFile.chunks); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = incomingFile.meta.name; a.textContent = `Descargar ${incomingFile.meta.name}`; a.className='d-block file-item'; chatBox.appendChild(a); chatBox.scrollTop = chatBox.scrollHeight; incomingFile = null; }
        else if(msg.type==='busy') appendSystem('El otro usuario está ocupado');
      }catch(e){ console.warn(e); }
    });
    conn.on('close', ()=>{ appendSystem('Conexión de datos cerrada'); conn = null; });
  }

  // conectar por ID (manual)
  connectToId.addEventListener('click', ()=>{ const id = otherIdInput.value.trim(); if(!id) return alert('Ingresá una ID'); connectById(id); });

  async function connectById(id){
    try{
      appendSystem('Conectando con ' + id + '...');
      conn = peer.connect(id, { reliable: true });
      conn.on('open', ()=>{ setupDataConn(); conn.send({type:'intro', name: localUser.name}); });
      conn.on('error', e=>{ console.warn(e); appendSystem('Error en conexión de datos'); });
      // llamada
      if(localStream){ currentCall = peer.call(id, localStream); currentCall.on('stream', s=>{ remoteVideo.srcObject = s; }); currentCall.on('close', ()=>{ remoteVideo.srcObject = null; currentCall = null; appendSystem('Llamada finalizada'); }); }
      roomLabel.textContent = 'Conectado a ' + id;
    }catch(e){ console.warn(e); appendSystem('No se pudo conectar: '+e); }
  }

  // Buscar aleatorio: intentamos listAllPeers (si el servidor lo soporta)
  findBtn.addEventListener('click', async ()=>{
    appendSystem('Buscando match...');
    try{
      if(typeof peer.listAllPeers !== 'function'){
        appendSystem('Discovery no soportado por este PeerServer. Usá "Copiar mi link" para conectar manualmente.'); findBtn.disabled=false; return;
      }
      peer.listAllPeers(peers=>{
        const candidates = (peers||[]).filter(p=>p && p !== peer.id);
        if(candidates.length === 0){ appendSystem('No hay peers disponibles. Abrí la URL en otro dispositivo o compartí tu link.'); findBtn.disabled=false; return; }
        const other = candidates[Math.floor(Math.random()*candidates.length)];
        appendSystem('Intentando conectar con '+other);
        connectById(other);
      });
    }catch(e){ console.warn(e); appendSystem('Error buscando peers: '+e); }
  });

  // copiar link
  copyLinkBtn.addEventListener('click', ()=>{
    const link = myLinkEl.textContent;
    navigator.clipboard.writeText(link).then(()=> appendSystem('Link copiado al portapapeles: ' + link)).catch(e=>{ appendSystem('No se pudo copiar link'); });
  });

  // chat send
  sendBtn.addEventListener('click', ()=>{ if(chatInput.value.trim()) sendChat(chatInput.value.trim()); });
  chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

  function sendChat(text){ const payload = {type:'chat', text, name: localUser.name}; if(conn && conn.open){ conn.send(payload); appendChat(text, 'Yo'); } else appendSystem('No estás conectado. Usá el link o conectá por ID.'); }

  // file send via data connection (chunked)
  sendFileBtn.addEventListener('click', async ()=>{
    const file = fileInput.files[0]; if(!file) return alert('Elegí un archivo');
    if(conn && conn.open){ conn.send({type:'file-meta', meta:{name:file.name,size:file.size,type:file.type}}); const chunkSize = 32*1024; let offset=0; while(offset < file.size){ const slice = file.slice(offset, offset+chunkSize); const buf = await slice.arrayBuffer(); conn.send({type:'file-chunk', chunk: buf}); offset += buf.byteLength; } conn.send({type:'file-end'}); appendSystem('Archivo enviado: '+file.name); }else alert('Conexión de datos no disponible');
  });

  // pass / stop
  passBtn.addEventListener('click', ()=>{ if(conn) try{ conn.close(); }catch(e){} if(currentCall) try{ currentCall.close(); }catch(e){} cleanupUI(); });
  stopBtn.addEventListener('click', ()=>{ if(conn) try{ conn.close(); }catch(e){} if(currentCall) try{ currentCall.close(); }catch(e){} cleanupUI(); });

  function cleanupUI(){ conn=null; currentCall=null; roomLabel.textContent='No conectado'; chatBox.innerHTML=''; }

  function appendSystem(text){ const div = document.createElement('div'); div.className='small-muted'; div.textContent=text; chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight; }
  function appendChat(text, name='El/La otro'){ const d = document.createElement('div'); d.className='mb-2'; d.innerHTML = `<strong>${name}:</strong> ${escapeHtml(text)}`; chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight; }
  function escapeHtml(unsafe){ return (unsafe||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;" }[c])); }

  // cleanup on unload
  window.addEventListener('beforeunload', ()=>{ try{ peer.destroy(); }catch(e){} });

  </script>
</body>
</html>