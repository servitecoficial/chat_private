<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alanet — Envío de archivos + Videollamada (P2P)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --brand: #4f46e5; }
    body { background: #0f172a; color: #e2e8f0; }
    .navbar { background: linear-gradient(90deg, #0ea5e9, #6366f1); }
    .brand-gradient { background: linear-gradient(90deg, #22d3ee, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card { background: #111827; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .form-control, .form-select { background: #0b1220; border-color: rgba(255,255,255,0.12); color: #e2e8f0; }
    .form-control:focus, .form-select:focus { border-color: #60a5fa; box-shadow: 0 0 0 .25rem rgba(99,102,241,.2) }
    .btn-brand { background: var(--brand); border: none; }
    .btn-brand:hover { filter: brightness(1.05); }
    .muted { opacity: .85; }
    .badge-soft { background: rgba(99,102,241,.15); color: #c7d2fe; border: 1px solid rgba(99,102,241,.35); }
    .log { height: 180px; overflow: auto; background: #adbcda; border-radius: .5rem; padding: .75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }
    .progress { background: rgba(255,255,255,.08); }
    video { width: 100%; background: #000; border-radius: .75rem; }
    a.download-link { word-break: break-all; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark mb-4">
    <div class="container">
      <span class="navbar-brand fw-semibold">Alanet</span>
      <span class="badge badge-soft">P2P WebRTC</span>
    </div>
  </nav>

  <div class="container">
    <div class="row g-4">
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h1 class="h4 mb-3 brand-gradient">Conectar</h1>
            <p class="small text-secondary muted mb-3">Escriban <strong>el mismo Nombre e Identificador</strong>. Una persona elige <b>Host</b> y la otra <b>Invitado</b>. Sin servidores propios ni base de datos: señalización usa <i>PeerJS Cloud</i> y la transferencia va P2P con WebRTC.</p>
            <div class="mb-3">
              <label class="form-label">Nombre (ID público)</label>
              <input id="name" class="form-control" placeholder="Ej: alanet-room" />
            </div>
            <div class="mb-3">
              <label class="form-label">Identificador (contraseña compartida)</label>
              <input id="secret" class="form-control" placeholder="Ej: 1234-seguro" />
            </div>
            <div class="mb-3">
              <label class="form-label">Rol</label>
              <select id="role" class="form-select">
                <option value="host">Host (espera conexiones)</option>
                <option value="guest">Invitado (se conecta)</option>
              </select>
            </div>
            <div class="d-grid gap-2">
              <button id="btnConnect" class="btn btn-brand btn-lg">Conectar</button>
              <button id="btnDisconnect" class="btn btn-outline-light" disabled>Desconectar</button>
            </div>
            <hr class="my-4" />
            <div class="small">
              <div class="mb-1">Tu Peer ID: <code id="myPeerId">—</code></div>
              <div class="mb-1">Peer remoto: <code id="remotePeerId">—</code></div>
              <div>Estado: <span class="badge bg-secondary" id="status">offline</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h5 m-0">Archivos & Chat</h2>
              <span class="badge bg-info" id="connQuality">WebRTC</span>
            </div>

            <div class="row g-3 align-items-end">
              <div class="col-sm-6">
                <label class="form-label">Elegir archivo</label>
                <input id="fileInput" type="file" class="form-control" />
              </div>
              <div class="col-sm-6 d-grid">
                <button id="btnSendFile" class="btn btn-brand" disabled>Enviar archivo</button>
              </div>
              <div class="col-12">
                <label class="form-label">Mensaje (chat)</label>
                <div class="input-group">
                  <input id="chatInput" class="form-control" placeholder="Escribe y presiona Enviar" />
                  <button id="btnSendMsg" class="btn btn-outline-light" disabled>Enviar</button>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="progress" role="progressbar" aria-label="Progreso de transferencia" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
              </div>
            </div>

            <div class="row mt-3 g-3">
              <div class="col-md-6">
                <h6>Actividad</h6>
                <div id="log" class="log"></div>
              </div>
              <div class="col-md-6">
                <h6>Descargas recibidas</h6>
                <div id="downloads" class="small"></div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h5 m-0">Videollamada</h2>
              <span class="badge bg-warning text-dark">Beta</span>
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-6">
                <label class="form-label">Tu cámara</label>
                <video id="localVideo" autoplay playsinline muted></video>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Remoto</label>
                <video id="remoteVideo" autoplay playsinline></video>
              </div>
              <div class="col-12 d-grid gap-2">
                <button id="btnStartCamera" class="btn btn-outline-light">Activar cámara/mic</button>
                <button id="btnCall" class="btn btn-brand" disabled>Iniciar videollamada</button>
                <button id="btnHangup" class="btn btn-outline-danger" disabled>Cortar</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <p class="text-center text-secondary small my-4">Hecho con ❤️ por <strong>Alanet (Alan Acosta)</strong>. P2P mediante WebRTC/PeerJS. No subir información sensible: algunas redes requieren TURN y este demo usa solo STUN públicos. <br>
    No me hago cargo del mal uso de este sitio.</p>
  </div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    // ======== Utilidades ========
    const $ = (s) => document.querySelector(s);
    const log = (m) => { const el = document.createElement('div'); el.textContent = `[${new Date().toLocaleTimeString()}] ${m}`; document.getElementById('log').prepend(el); };
    const setStatus = (t, cls) => { const s = document.getElementById('status'); s.textContent = t; s.className = `badge ${cls}`; };

    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function deriveRoomId(name, secret) {
      const norm = `${(name||'').trim().toLowerCase()}::${(secret||'').trim()}`;
      return sha256Hex(norm).then(hex => `alanet-${hex.slice(0, 24)}`);
    }

    // ======== Estado global ========
    let peer = null;            // PeerJS Peer
    let dataConn = null;        // DataConnection
    let mediaCall = null;       // MediaConnection
    let remotePeerId = null;
    let localStream = null;

    // Chunking
    const CHUNK_SIZE = 64 * 1024; // 64KB por chunk
    let receiving = null; // {name, size, received, chunks: []}

    // STUN servers (públicos). Para máxima compatibilidad, agrega TURN propio si lo tienes.
    const rtcConfig = {
      iceServers: [
        { urls: [
          'stun:stun.l.google.com:19302',
          'stun:global.stun.twilio.com:3478',
          'stun:stun1.l.google.com:19302'
        ]}
      ]
    };

    function enableConnectedUI(enable) {
      document.getElementById('btnSendFile').disabled = !enable;
      document.getElementById('btnSendMsg').disabled = !enable;
      document.getElementById('btnDisconnect').disabled = !enable;
      document.getElementById('btnCall').disabled = !enable || !localStream;
    }

    function updateProgress(percent) {
      const pb = document.getElementById('progressBar');
      pb.style.width = `${percent}%`;
      pb.textContent = `${Math.floor(percent)}%`;
    }

    function resetProgress() { updateProgress(0); }

    // ======== Conexión ========
    document.getElementById('btnConnect').addEventListener('click', async () => {
      const name = document.getElementById('name').value;
      const secret = document.getElementById('secret').value;
      const role = document.getElementById('role').value;
      if (!name || !secret) { alert('Completa Nombre e Identificador.'); return; }

      const roomId = await deriveRoomId(name, secret);
      log(`Room ID derivado: ${roomId}`);

      // Limpia si existía
      if (peer) { try { peer.destroy(); } catch(e){} }

      if (role === 'host') {
        peer = new Peer(roomId, { debug: 1, config: rtcConfig });
        setStatus('conectando…', 'bg-warning');

        peer.on('open', id => {
          document.getElementById('myPeerId').textContent = id;
          setStatus('esperando invitado…', 'bg-info');
          log('Host listo. Comparte el Nombre/Identificador con el invitado.');
        });

        peer.on('connection', conn => {
          dataConn = conn;
          remotePeerId = conn.peer;
          document.getElementById('remotePeerId').textContent = remotePeerId;
          setupDataConn();
          log(`Conexión de datos establecida con ${remotePeerId}`);
        });

        peer.on('call', call => {
          mediaCall = call;
          if (localStream) call.answer(localStream);
          call.on('stream', stream => { document.getElementById('remoteVideo').srcObject = stream; });
          call.on('close', () => { document.getElementById('remoteVideo').srcObject = null; });
        });

        peer.on('error', e => { log('Error Peer: '+e); setStatus('error', 'bg-danger'); });

      } else { // guest
        peer = new Peer(undefined, { debug: 1, config: rtcConfig });
        setStatus('conectando…', 'bg-warning');

        peer.on('open', id => {
          document.getElementById('myPeerId').textContent = id;
          // Se conecta al host (roomId)
          dataConn = peer.connect(roomId, { reliable: true });
          setupDataConn();
          log(`Intentando conectar con host ${roomId}…`);
        });

        peer.on('call', call => {
          mediaCall = call;
          if (localStream) call.answer(localStream);
          call.on('stream', stream => { document.getElementById('remoteVideo').srcObject = stream; });
          call.on('close', () => { document.getElementById('remoteVideo').srcObject = null; });
        });

        peer.on('error', e => { log('Error Peer: '+e); setStatus('error', 'bg-danger'); });
      }

      document.getElementById('btnDisconnect').disabled = false;
    });

    function setupDataConn() {
      if (!dataConn) return;
      dataConn.on('open', () => {
        setStatus('conectado', 'bg-success');
        enableConnectedUI(true);
        document.getElementById('remotePeerId').textContent = dataConn.peer;
        // Intercambia tus IDs para facilitar la videollamada en ambas direcciones
        dataConn.send({ type: 'hello', id: peer.id });
        log('Canal de datos listo.');
      });

      dataConn.on('data', (msg) => {
        if (typeof msg === 'string') {
          log(`Mensaje: ${msg}`);
          return;
        }
        // Mensajes estructurados
        switch (msg.type) {
          case 'hello':
            remotePeerId = msg.id;
            document.getElementById('remotePeerId').textContent = remotePeerId;
            log(`Intercambiado ID remoto: ${remotePeerId}`);
            break;
          case 'chat':
            log(`Remoto: ${msg.text}`);
            break;
          case 'file-meta':
            receiving = { name: msg.name, size: msg.size, received: 0, chunks: [] };
            log(`Recibiendo: ${msg.name} (${(msg.size/1024/1024).toFixed(2)} MB)`);
            updateProgress(0);
            break;
          case 'file-chunk':
            if (receiving) {
              receiving.chunks.push(msg.data);
              receiving.received += msg.data.byteLength;
              const p = (receiving.received / receiving.size) * 100;
              updateProgress(p);
            }
            break;
          case 'file-end':
            if (receiving) {
              const blob = new Blob(receiving.chunks);
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = receiving.name; a.className = 'download-link d-block mb-2';
              a.textContent = `⬇️ ${receiving.name} (${(receiving.size/1024/1024).toFixed(2)} MB)`;
              document.getElementById('downloads').prepend(a);
              log(`Archivo recibido: ${receiving.name}`);
              receiving = null; resetProgress();
            }
            break;
        }
      });

      dataConn.on('close', () => {
        setStatus('desconectado', 'bg-secondary');
        enableConnectedUI(false);
        log('Conexión cerrada.');
      });

      dataConn.on('error', (e) => {
        log('Error DataConn: ' + e);
      });
    }

    // ======== Enviar mensajes ========
    document.getElementById('btnSendMsg').addEventListener('click', () => {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !dataConn?.open) return;
      dataConn.send({ type: 'chat', text });
      log(`Tú: ${text}`);
      input.value = '';
    });
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('btnSendMsg').click(); }
    });

    // ======== Envío de archivos (chunked) ========
    document.getElementById('btnSendFile').addEventListener('click', async () => {
      if (!dataConn?.open) { alert('No conectado'); return; }
      const file = document.getElementById('fileInput').files?.[0];
      if (!file) { alert('Elige un archivo'); return; }

      log(`Enviando: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
      dataConn.send({ type: 'file-meta', name: file.name, size: file.size });

      const reader = file.stream().getReader();
      let sent = 0;
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const buf = value.buffer.slice(value.byteOffset, value.byteOffset + value.byteLength);
        dataConn.send({ type: 'file-chunk', data: buf });
        sent += value.byteLength;
        updateProgress((sent / file.size) * 100);
        await new Promise(r => setTimeout(r, 0)); // cede al UI
      }
      dataConn.send({ type: 'file-end' });
      log('Archivo enviado.');
      resetProgress();
    });

    // ======== Cámara y Llamadas ========
    document.getElementById('btnStartCamera').addEventListener('click', async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('btnCall').disabled = !(dataConn && dataConn.open);
        log('Cámara y micrófono activos.');
      } catch (e) {
        alert('No se pudo acceder a la cámara/mic: ' + e.message);
      }
    });

    document.getElementById('btnCall').addEventListener('click', async () => {
      if (!localStream) { alert('Activa la cámara primero.'); return; }
      if (!remotePeerId) { alert('Aún no tenemos el ID remoto. Espera a que el canal de datos esté listo.'); return; }
      if (!peer) return;
      try {
        mediaCall = peer.call(remotePeerId, localStream);
        mediaCall.on('stream', stream => { document.getElementById('remoteVideo').srcObject = stream; });
        mediaCall.on('close', () => { document.getElementById('remoteVideo').srcObject = null; });
        document.getElementById('btnHangup').disabled = false;
        log('Videollamada iniciada.');
      } catch (e) { alert('Error al llamar: ' + e.message); }
    });

    document.getElementById('btnHangup').addEventListener('click', () => {
      if (mediaCall) { mediaCall.close(); mediaCall = null; }
      document.getElementById('remoteVideo').srcObject = null;
      document.getElementById('btnHangup').disabled = true;
      log('Videollamada finalizada.');
    });

    // ======== Desconectar ========
    document.getElementById('btnDisconnect').addEventListener('click', () => {
      try { if (dataConn) dataConn.close(); } catch(e){}
      try { if (mediaCall) mediaCall.close(); } catch(e){}
      try { if (peer) peer.destroy(); } catch(e){}
      dataConn = null; mediaCall = null; peer = null; remotePeerId = null;
      document.getElementById('myPeerId').textContent = '—';
      document.getElementById('remotePeerId').textContent = '—';
      setStatus('offline', 'bg-secondary');
      enableConnectedUI(false);
      log('Desconectado.');
    });

    // Accesibilidad: enviar con Ctrl+Enter
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        const el = document.activeElement;
        if (el === document.getElementById('chatInput')) {
          document.getElementById('btnSendMsg').click();
        }
      }
    });
  </script>
</body>
</html>